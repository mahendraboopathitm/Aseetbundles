name: Databricks Asset Bundle Deploy - Git to Prod

on:
  workflow_dispatch:
    inputs:
      bundle_name:
        description: 'Specific bundle to deploy (leave empty for all)'
        required: false
        type: string

  push:
    branches:
      - main
    paths:
      - 'dev_cicd/**'

jobs:
  deploy-databricks-bundles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh

      # üîç Verify DEV connection
      - name: Verify DEV Databricks connection
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_DEV_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_DEV_TOKEN }}
        run: |
          echo "Testing DEV workspace..."
          databricks workspace list /Shared

      # ‚úÖ Validate bundles in DEV
      - name: Validate bundles (DEV)
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_DEV_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_DEV_TOKEN }}
        run: |
          cd Aseetbundles/dev_cicd

          for bundle_dir in */; do
            if [ -f "$bundle_dir/databricks.yml" ]; then
              echo "Validating bundle: $bundle_dir"
              cd "$bundle_dir"

              databricks bundle validate --target dev || exit 1

              cd ..
            fi
          done

      # üöÄ Deploy to PROD
      - name: Deploy bundles to Production
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_PROD_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_PROD_TOKEN }}
        run: |
          cd Aseetbundles/dev_cicd
          BUNDLE_NAME="${{ github.event.inputs.bundle_name }}"

          if [ -n "$BUNDLE_NAME" ]; then
            echo "Deploying specific bundle to PROD: $BUNDLE_NAME"
            cd "$BUNDLE_NAME"

            databricks bundle deploy --target prod
          else
            echo "Deploying all bundles to PROD..."
            for bundle_dir in */; do
              if [ -f "$bundle_dir/databricks.yml" ]; then
                echo "Deploying bundle: $bundle_dir"
                cd "$bundle_dir"

                databricks bundle deploy --target prod

                cd ..
              fi
            done
          fi

      - name: Send success notification
        if: success()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"‚úÖ Databricks Asset Bundles deployed to PROD successfully\"
              }"
          fi

      - name: Send failure notification
        if: failure()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"‚ùå Databricks Asset Bundle PROD deployment FAILED\"
              }"
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.databrickscfg || true
