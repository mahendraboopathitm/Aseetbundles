name: Databricks Asset Bundle Deploy - Git to Prod

on:
  workflow_dispatch:
    inputs:
      bundle_name:
        description: 'Specific bundle to deploy (leave empty for all)'
        required: false
        type: string

  push:
    branches:
      - main
    paths:
      - 'dev_cicd/**'

env:
  DEV_WORKSPACE_URL: ${{ secrets.DATABRICKS_DEV_HOST }}
  DEV_TOKEN: ${{ secrets.DATABRICKS_DEV_TOKEN }}
  PROD_WORKSPACE_URL: ${{ secrets.DATABRICKS_PROD_HOST }}
  PROD_TOKEN: ${{ secrets.DATABRICKS_PROD_TOKEN }}

jobs:
  deploy-databricks-bundles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh

          databricks configure --host "$DEV_WORKSPACE_URL" --token "$DEV_TOKEN" --profile DEV
          databricks configure --host "$PROD_WORKSPACE_URL" --token "$PROD_TOKEN" --profile PROD

      - name: Verify Databricks connections
        run: |
          echo "Testing DEV workspace..."
          databricks workspace list /Shared --profile DEV

          echo "Testing PROD workspace..."
          databricks workspace list /Shared --profile PROD

      # ‚úÖ Validate bundles in DEV (safety check)
      - name: Validate bundles (Git source)
        run: |
          cd databricks-bundles/Assetbundles

          for bundle_dir in */; do
            if [ -f "$bundle_dir/databricks.yml" ]; then
              echo "Validating bundle: $bundle_dir"
              cd "$bundle_dir"

              databricks bundle validate \
                --profile DEV \
                --target dev || exit 1

              cd ..
            fi
          done

      # üöÄ Deploy to PROD
      - name: Deploy bundles to Production
        run: |
          cd databricks-bundles/Assetbundles
          BUNDLE_NAME="${{ github.event.inputs.bundle_name }}"

          if [ -n "$BUNDLE_NAME" ]; then
            echo "Deploying specific bundle to PROD: $BUNDLE_NAME"
            cd "$BUNDLE_NAME"

            databricks bundle deploy \
              --profile PROD \
              --target prod
          else
            echo "Deploying all bundles to PROD..."
            for bundle_dir in */; do
              if [ -f "$bundle_dir/databricks.yml" ]; then
                echo "Deploying bundle: $bundle_dir"
                cd "$bundle_dir"

                databricks bundle deploy \
                  --profile PROD \
                  --target prod

                cd ..
              fi
            done
          fi

      - name: Send success notification
        if: success()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "‚úÖ Databricks Asset Bundles deployed to PROD successfully"
              }'
          fi

      - name: Send failure notification
        if: failure()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "‚ùå Databricks Asset Bundle PROD deployment FAILED"
              }'
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.databrickscfg
